<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>fs2-data - Generic</title>
    <link rel="stylesheet" href="/css/stylesheet.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="/css/materialize.min.css" media="screen,projection"/>
    <style>body{font-family: overpass, sans-serif; }</style>

    <script type="text/javascript" src="/js/materialize.min.js"></script>

    <!-- search index -->
    <link rel="stylesheet" href="/css/stork.css" />
    <script src="/js/stork.js"></script>

    <meta name="generator" content="Nanoc 4.12.16">
  </head>
  <body>
    <header>
        <nav class="nav-extended red darken-2">
          <a href="#!" class="brand-logo right">fs2-data</a>
          <a href="#" data-target="collapsed" class="sidenav-trigger"><i class="material-icons">menu</i></a>
          <div class="nav-wrapper">
            <ul id="nav-mobile" class="left hide-on-med-and-down">
              <li><a href="/">Home</a></li>
              <li><a href="/documentation/">Documentation</a></li>
              <li><a href="/api/">Scaladoc</a></li>
              <li><a href="https://github.com/gnieh/fs2-data">Github</a></li>
              <li><i class="material-icons">search</i></li>
              <li>
                <form>
                  <div class="input-field">
                    <input data-stork="search" id="search" type="search" required placeholder="Search the website" autocomplete="off" />
                  </div>
                </form>
              </li>
            </ul>
          </div>
          
          
          <div class="nav-content">
            <ul class="tabs tabs-transparent">
              
              
              <li class="tab"><a href="/documentation/csv/">CSV</a></li>
              
              
              
              <li class="tab active"><a href="/documentation/csv/generic/">Generic</a></li>
              
              
            </ul>
          </div>
          
        </nav>
        <div class="stork-wrapper-flat">
          <div data-stork="search-output" class="stork-output"></div>
        </div>

    </header>

    <ul class="sidenav" id="collapsed">
      <li><a href="/">Home</a></li>
      <li><a href="/documentation/">Documentation</a></li>
      <li><a href="/api/">Scaladoc</a></li>
      <li><a href="https://github.com/gnieh/fs2-data">Github</a></li>
    </ul>

    
    <div class="fixed-action-btn tooltipped" data-position="left" data-tooltip="Edit this page">
      <a class="btn-floating btn-large blue darken-2" href="https://github.com/gnieh/fs2-data/edit/main/documentation/docs/csv/generic.md" target="_blank">
        <i class="large material-icons">mode_edit</i>
      </a>
    </div>
    

    <main>
      <div class="container">
        <p>Module: <a href="https://mvnrepository.com/artifact/org.gnieh/fs2-data-csv-generic_2.13"><img src="https://img.shields.io/maven-central/v/org.gnieh/fs2-data-csv-generic_2.13.svg" alt="Maven Central" /></a></p>

<p>The <code>fs2-data-csv-generic</code> module provides automatic (Scala 2-only) and semi-automatic derivation for <code>RowDecoder</code> and <code>CsvRowDecoder</code>.</p>

<p>It makes it easier to support custom row types but is based on <a href="https://github.com/milessabin/shapeless">shapeless</a>, which can have a significant impact on compilation time on Scala 2. On Scala 3, it relies on mix of hand-written derivation on top of <code>scala.deriving.Mirror</code> and the more light-weight <a href="https://github.com/typelevel/shapeless-3">shapeless-3</a>, so that compile times shouldn’t be problematic as on Scala 2. Note that auto derivation is currently not yet supported on Scala, same goes for using default constructor arguments of <code>case class</code>es (for background see <a href="https://github.com/lampepfl/dotty/pull/11667">dotty#11667</a>).</p>

<p>To demonstrate how it works, let’s work again with the CSV data from the <a href="/documentation/csv/">core</a> module documentation.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2._</span>
<span class="k">import</span> <span class="nn">fs2.data.csv._</span>

<span class="k">val</span> <span class="nv">input</span> <span class="k">=</span> <span class="s">"""i,s,j
              |1,test,2
              |,other,-3
              |"""</span><span class="o">.</span><span class="py">stripMargin</span>
<span class="c1">// input: String = """i,s,j</span>
<span class="c1">// 1,test,2</span>
<span class="c1">// ,other,-3</span>
<span class="c1">// """</span>

<span class="k">val</span> <span class="nv">stream</span> <span class="k">=</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="n">input</span><span class="o">).</span><span class="py">covary</span><span class="o">[</span><span class="kt">Fallible</span><span class="o">]</span>
<span class="c1">// stream: Stream[Fallible, String] = Stream(..)</span>
</code></pre></div></div>

<p>This page covers the following topics:</p>
<ul id="markdown-toc">
  <li><a href="#derivation-of-celldecoder--cellencoder" id="markdown-toc-derivation-of-celldecoder--cellencoder">Derivation of <code>CellDecoder</code> &amp; <code>CellEncoder</code></a></li>
  <li><a href="#derivation-of-rowdecoder--rowencoder" id="markdown-toc-derivation-of-rowdecoder--rowencoder">Derivation of <code>RowDecoder</code> &amp; <code>RowEncoder</code></a></li>
  <li><a href="#derivation-of-csvrowdecoder" id="markdown-toc-derivation-of-csvrowdecoder">Derivation of <code>CsvRowDecoder</code></a></li>
</ul>

<h3 id="derivation-of-celldecoder--cellencoder">Derivation of <code>CellDecoder</code> &amp; <code>CellEncoder</code></h3>

<p>Cell types (<code>Int</code>, <code>String</code>, …) can be decoded and encoded by providing implicit instances of <code>CellDecoder</code>/<code>CellEncoder</code>. Instances for primitives and common types are defined already. You can easily define your own or use generic derivation for coproducts:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.csv.generic._</span>
<span class="k">import</span> <span class="nn">fs2.data.csv.generic.semiauto._</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">State</span>
<span class="k">object</span> <span class="nc">State</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">On</span> <span class="k">extends</span> <span class="nc">State</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">Off</span> <span class="k">extends</span> <span class="nc">State</span>
<span class="o">}</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">stateDecoder</span> <span class="k">=</span> <span class="n">deriveCellDecoder</span><span class="o">[</span><span class="kt">State</span><span class="o">]</span>
<span class="c1">// stateDecoder: CellDecoder[State] = fs2.data.csv.generic.internal.DerivedCellDecoder$$anonfun$coproductDecoder$3@41340a42</span>
<span class="c1">// use stateDecoder to derive decoders for rows...or just test:</span>
<span class="nf">stateDecoder</span><span class="o">(</span><span class="s">"On"</span><span class="o">)</span>
<span class="c1">// res1: DecoderResult[State] = Right(value = On)</span>
<span class="nf">stateDecoder</span><span class="o">(</span><span class="s">"Off"</span><span class="o">)</span>
<span class="c1">// res2: DecoderResult[State] = Right(value = Off)</span>

<span class="c1">// same goes for the encoder</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">stateEncoder</span> <span class="k">=</span> <span class="n">deriveCellEncoder</span><span class="o">[</span><span class="kt">State</span><span class="o">]</span>
<span class="c1">// stateEncoder: CellEncoder[State] = fs2.data.csv.generic.internal.DerivedCellEncoder$$anonfun$coproductEncoder$3@4ea6e3d</span>
<span class="nf">stateEncoder</span><span class="o">(</span><span class="nv">State</span><span class="o">.</span><span class="py">On</span><span class="o">)</span>
<span class="c1">// res3: String = "On"</span>
</code></pre></div></div>

<p>The generic derivation for cell decoders also supports renaming and deriving instances for unary product types (case classes with one field):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.csv.generic.semiauto._</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Advanced</span>
<span class="k">object</span> <span class="nc">Advanced</span> <span class="o">{</span>
  <span class="nd">@CsvValue</span><span class="o">(</span><span class="s">"Active"</span><span class="o">)</span> <span class="k">case</span> <span class="k">object</span> <span class="nc">On</span> <span class="k">extends</span> <span class="nc">Advanced</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Unknown</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Advanced</span>
<span class="o">}</span>

<span class="c1">// works as we have an implicit CellDecoder[String]</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">unknownDecoder</span> <span class="k">=</span> <span class="n">deriveCellDecoder</span><span class="o">[</span><span class="kt">Advanced.Unknown</span><span class="o">]</span>
<span class="c1">// unknownDecoder: CellDecoder[Advanced.Unknown] = fs2.data.csv.generic.internal.DerivedCellDecoder$$anonfun$unaryProductDecoder$3@49626ad4</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">advancedDecoder</span> <span class="k">=</span> <span class="n">deriveCellDecoder</span><span class="o">[</span><span class="kt">Advanced</span><span class="o">]</span>
<span class="c1">// advancedDecoder: CellDecoder[Advanced] = fs2.data.csv.generic.internal.DerivedCellDecoder$$anonfun$coproductDecoder$3@4c613fd1</span>

<span class="nf">advancedDecoder</span><span class="o">(</span><span class="s">"Active"</span><span class="o">)</span>
<span class="c1">// res4: DecoderResult[Advanced] = Right(value = On)</span>
<span class="nf">advancedDecoder</span><span class="o">(</span><span class="s">"Off"</span><span class="o">)</span>
<span class="c1">// res5: DecoderResult[Advanced] = Right(value = Unknown(name = "Off"))</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">unknownEncoder</span> <span class="k">=</span> <span class="n">deriveCellEncoder</span><span class="o">[</span><span class="kt">Advanced.Unknown</span><span class="o">]</span>
<span class="c1">// unknownEncoder: CellEncoder[Advanced.Unknown] = fs2.data.csv.generic.internal.DerivedCellEncoder$$anonfun$unaryProductEncoder$3@2de65a05</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">advancedEncoder</span> <span class="k">=</span> <span class="n">deriveCellEncoder</span><span class="o">[</span><span class="kt">Advanced</span><span class="o">]</span>
<span class="c1">// advancedEncoder: CellEncoder[Advanced] = fs2.data.csv.generic.internal.DerivedCellEncoder$$anonfun$coproductEncoder$3@7aaa4202</span>

<span class="nf">advancedEncoder</span><span class="o">(</span><span class="nv">Advanced</span><span class="o">.</span><span class="py">On</span><span class="o">)</span>
<span class="c1">// res6: String = "Active"</span>
<span class="nf">advancedEncoder</span><span class="o">(</span><span class="nv">Advanced</span><span class="o">.</span><span class="py">Unknown</span><span class="o">(</span><span class="s">"Off"</span><span class="o">))</span>
<span class="c1">// res7: String = "Off"</span>
</code></pre></div></div>

<h3 id="derivation-of-rowdecoder--rowencoder">Derivation of <code>RowDecoder</code> &amp; <code>RowEncoder</code></h3>

<p>One can automatically derive an instance for a <a href="https://github.com/milessabin/shapeless">shapeless</a> <code>HList</code> if there are instances for all cell types. The example previously written manually now looks like:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">shapeless._</span>
<span class="k">import</span> <span class="nn">fs2.data.csv.generic.hlist._</span>

<span class="c1">// .tail drops the header line</span>
<span class="k">val</span> <span class="nv">hlists</span> <span class="k">=</span> <span class="nv">stream</span><span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="n">decodeSkippingHeaders</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="kt">::</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Int</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]())</span>
<span class="c1">// hlists: Stream[[x]Fallible[x], Option[Int] :: String :: Int :: HNil] = Stream(..)</span>
<span class="nv">hlists</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">toList</span>
<span class="c1">// res8: Either[Throwable, List[Option[Int] :: String :: Int :: HNil]] = Right(</span>
<span class="c1">//   value = List(</span>
<span class="c1">//     Some(value = 1) :: "test" :: 2 :: HNil,</span>
<span class="c1">//     None :: "other" :: -3 :: HNil</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="derivation-of-csvrowdecoder">Derivation of <code>CsvRowDecoder</code></h3>

<p>Let’s say you want to decode the CSV row to the following case class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">MyRow</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">j</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</code></pre></div></div>

<p>You can get an automatically derived <code>CsvRowDecoder</code> (and a matching <code>CsvRowEncoder</code>) for every case class by importing <code>fs2.data.csv.generic.auto._</code></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.csv.generic.auto._</span>

<span class="k">val</span> <span class="nv">roundtrip</span> <span class="k">=</span> <span class="nv">stream</span><span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="n">decodeUsingHeaders</span><span class="o">[</span><span class="kt">MyRow</span><span class="o">]())</span>
  <span class="c1">// and back - note that types and corresponding are all inferred</span>
  <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nf">encodeUsingFirstHeaders</span><span class="o">(</span><span class="n">fullRows</span> <span class="k">=</span> <span class="kc">true</span><span class="o">))</span>
<span class="c1">// roundtrip: Stream[[x]Fallible[x], String] = Stream(..)</span>
<span class="nv">roundtrip</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">string</span>
<span class="c1">// res9: Either[Throwable, String] = Right(</span>
<span class="c1">//   value = """i,j,s</span>
<span class="c1">// 1,2,test</span>
<span class="c1">// ,-3,other</span>
<span class="c1">// """</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>Automatic derivation can be quite slow at compile time, so you might want to opt for semiautomatic derivation. In this case, you need to explicitly define the implicit instance in scope.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.csv.generic.semiauto._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">MyRowDecoder</span><span class="k">:</span> <span class="kt">CsvRowDecoder</span><span class="o">[</span><span class="kt">MyRow</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">deriveCsvRowDecoder</span><span class="o">[</span><span class="kt">MyRow</span><span class="o">]</span>
<span class="c1">// MyRowDecoder: CsvRowDecoder[MyRow, String] = fs2.data.csv.generic.internal.DerivedCsvRowDecoder$$anon$1@52a530f5</span>

<span class="k">val</span> <span class="nv">decoded</span> <span class="k">=</span> <span class="nv">stream</span><span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="n">decodeUsingHeaders</span><span class="o">[</span><span class="kt">MyRow</span><span class="o">]())</span>
<span class="c1">// decoded: Stream[[x]Fallible[x], MyRow] = Stream(..)</span>
<span class="nv">decoded</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">toList</span>
<span class="c1">// res10: Either[Throwable, List[MyRow]] = Right(</span>
<span class="c1">//   value = List(</span>
<span class="c1">//     MyRow(i = Some(value = 1), j = 2, s = "test"),</span>
<span class="c1">//     MyRow(i = None, j = -3, s = "other")</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>Both automatic and semi-automatic decoders support also default values when decoding, so instead of an <code>Option[Int]</code> for <code>i</code>, you can define this class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.csv.generic.auto._</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">MyRowDefault</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">42</span><span class="o">,</span> <span class="n">j</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">decoded</span> <span class="k">=</span> <span class="nv">stream</span><span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="n">decodeUsingHeaders</span><span class="o">[</span><span class="kt">MyRowDefault</span><span class="o">]())</span>
<span class="c1">// decoded: Stream[[x]Fallible[x], MyRowDefault] = Stream(..)</span>
<span class="nv">decoded</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">toList</span>
<span class="c1">// res11: Either[Throwable, List[MyRowDefault]] = Left(</span>
<span class="c1">//   value = fs2.data.csv.DecoderError: unable to decode '' as an integer in line 3</span>
<span class="c1">// )</span>
</code></pre></div></div>


      </div>
    </main>

    <footer class="page-footer red lighten-2">
      <div class="footer-copyright red darken-2">
        <div class="container">
          Copyright © 2019-2023 <a class="grey-text text-lighten-4" href="https://fosstodon.org/@lucassatabin">@lucassatabin</a>
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" class="grey-text text-lighten-4 right" /></a>
          <br />
          <a href="https://typelevel.org/projects/"><img alt="Typelevel Affiliate Project" style="border-width:0" src="https://img.shields.io/badge/typelevel-affiliate%20project-FFB4B5.svg" /></a>
          <a href="https://discord.gg/7qNAFsYkTn"><img alt="Discord" style="border-width:0" src="https://img.shields.io/discord/632277896739946517.svg?label=&logo=discord&logoColor=ffffff&color=404244&labelColor=6A7EC2" /></a>
        </div>
      </div>
    </footer>

    <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('.sidenav');
      var instances = M.Sidenav.init(elems, {});
    });
    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('.tooltipped');
      var instances = M.Tooltip.init(elems, {});
    });

    stork.initialize("/js/stork.wasm")
    stork.register("search", "/index.st", { showCloseButton: false })
    </script>

</html>
