<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>fs2-data - JSONPath</title>
    <link rel="stylesheet" href="/css/stylesheet.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="/css/materialize.min.css" media="screen,projection"/>
    <style>body{font-family: overpass, sans-serif; }</style>

    <script type="text/javascript" src="/js/materialize.min.js"></script>

    <!-- search index -->
    <link rel="stylesheet" href="/css/stork.css" />
    <script src="/js/stork.js"></script>

    <meta name="generator" content="Nanoc 4.12.14">
  </head>
  <body>
    <header>
        <nav class="nav-extended red darken-2">
          <a href="#!" class="brand-logo right">fs2-data</a>
          <a href="#" data-target="collapsed" class="sidenav-trigger"><i class="material-icons">menu</i></a>
          <div class="nav-wrapper">
            <ul id="nav-mobile" class="left hide-on-med-and-down">
              <li><a href="/">Home</a></li>
              <li><a href="/documentation/">Documentation</a></li>
              <li><a href="/api/">Scaladoc</a></li>
              <li><a href="https://github.com/gnieh/fs2-data">Github</a></li>
              <li><i class="material-icons">search</i></li>
              <li>
                <form>
                  <div class="input-field">
                    <input data-stork="search" id="search" type="search" required placeholder="Search the website" autocomplete="off" />
                  </div>
                </form>
              </li>
            </ul>
          </div>
          
          
          <div class="nav-content">
            <ul class="tabs tabs-transparent">
              
              
              <li class="tab"><a href="/documentation/json/">JSON</a></li>
              
              
              
              <li class="tab"><a href="/documentation/json/libraries/">JSON Libraries</a></li>
              
              
              
              <li class="tab active"><a href="/documentation/json/jsonpath/">JSONPath</a></li>
              
              
              
              <li class="tab"><a href="/documentation/json/patches/">JSON Patch</a></li>
              
              
              
              <li class="tab"><a href="/documentation/json/interpolators/">Interpolators</a></li>
              
              
            </ul>
          </div>
          
        </nav>
        <div class="stork-wrapper-flat">
          <div data-stork="search-output" class="stork-output"></div>
        </div>

    </header>

    <ul class="sidenav" id="collapsed">
      <li><a href="/">Home</a></li>
      <li><a href="/documentation/">Documentation</a></li>
      <li><a href="/api/">Scaladoc</a></li>
      <li><a href="https://github.com/gnieh/fs2-data">Github</a></li>
    </ul>

    
    <div class="fixed-action-btn tooltipped" data-position="left" data-tooltip="Edit this page">
      <a class="btn-floating btn-large blue darken-2" href="https://github.com/gnieh/fs2-data/edit/main/documentation/docs/json/jsonpath.md" target="_blank">
        <i class="large material-icons">mode_edit</i>
      </a>
    </div>
    

    <main>
      <div class="container">
        <p>Module: <a href="https://mvnrepository.com/artifact/org.gnieh/fs2-data-json_2.13"><img src="https://img.shields.io/maven-central/v/org.gnieh/fs2-data-json_2.13.svg" alt="Maven Central" /></a></p>

<p>The <code>fs2-data-json</code> module provides a streaming implementation of JSONPath.</p>

<p>This page covers the following topics:</p>
<ul id="markdown-toc">
  <li><a href="#jsonpath" id="markdown-toc-jsonpath">JSONPath</a>    <ul>
      <li><a href="#parsing-a-string-using-the-jsonpath-parser" id="markdown-toc-parsing-a-string-using-the-jsonpath-parser">Parsing a string using the JSONPath parser</a></li>
      <li><a href="#using-jsonpath" id="markdown-toc-using-jsonpath">Using JSONPath</a></li>
    </ul>
  </li>
</ul>

<p>Let’s use the following JSON input as an example.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.syntax.all._</span>

<span class="k">import</span> <span class="nn">fs2._</span>
<span class="k">import</span> <span class="nn">fs2.data.json._</span>

<span class="k">val</span> <span class="nv">input</span> <span class="k">=</span> <span class="s">"""{
              |  "field1": 0,
              |  "field2": "test",
              |  "field3": [1, 2, 3]
              |}
              |{
              |  "field1": 2,
              |  "field3": []
              |}"""</span><span class="o">.</span><span class="py">stripMargin</span>
<span class="c1">// input: String = """{</span>
<span class="c1">//   "field1": 0,</span>
<span class="c1">//   "field2": "test",</span>
<span class="c1">//   "field3": [1, 2, 3]</span>
<span class="c1">// }</span>
<span class="c1">// {</span>
<span class="c1">//   "field1": 2,</span>
<span class="c1">//   "field3": []</span>
<span class="c1">// }"""</span>

<span class="k">val</span> <span class="nv">stream</span> <span class="k">=</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="n">input</span><span class="o">).</span><span class="py">through</span><span class="o">(</span><span class="n">tokens</span><span class="o">[</span><span class="kt">Fallible</span>, <span class="kt">String</span><span class="o">])</span>
<span class="c1">// stream: Stream[[A]Fallible[A], Token] = Stream(..)</span>
</code></pre></div></div>

<h3 id="jsonpath">JSONPath</h3>

<p>A subset of <a href="https://goessner.net/articles/JsonPath/index.html">JSONPath</a> can be used to select a subset of a JSON token stream. There are several ways to create selectors:</p>
<ul>
  <li>build the selector using the constructors, which can be quite verbose and cumbersome;</li>
  <li>parse a string with the JSONPath parser;</li>
  <li>use the <code>jsonpath</code> interpolator.</li>
</ul>

<h4 id="parsing-a-string-using-the-jsonpath-parser">Parsing a string using the JSONPath parser</h4>

<p>For instance, to select and enumerate elements that are in the <code>field3</code> array, you can create this selector. Only the tokens describing the values in <code>field3</code> will be emitted as a result.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.json.jsonpath._</span>

<span class="k">val</span> <span class="nv">selector</span> <span class="k">=</span> <span class="nv">JsonPathParser</span><span class="o">.</span><span class="py">either</span><span class="o">(</span><span class="s">"$.field3[*]"</span><span class="o">)</span>
<span class="c1">// selector: Either[Throwable, JsonPath] = Right(</span>
<span class="c1">//   value = JsonPath(</span>
<span class="c1">//     locations = NonEmptyList(</span>
<span class="c1">//       head = Child(child = Name(n = "field3")),</span>
<span class="c1">//       tail = List(Pred(predicate = Wildcard))</span>
<span class="c1">//     )</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>The JSONPath parser wraps the result in anything that has an <a href="https://typelevel.org/cats/api/cats/MonadError.html"><code>MonadError</code> with error type <code>Throwable</code></a> to catch potential parsing errors. If you prefer not to have this wrapping, you can use the <code>jsonpath</code> interpolator.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.json.jsonpath.literals._</span>

<span class="k">val</span> <span class="nv">path</span> <span class="k">=</span> <span class="n">jsonpath</span><span class="s">"$$.field3[*]"</span>
<span class="c1">// path: JsonPath = JsonPath(</span>
<span class="c1">//   locations = NonEmptyList(</span>
<span class="c1">//     head = Child(child = Name(n = "field3")),</span>
<span class="c1">//     tail = List(Pred(predicate = Wildcard))</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>Because <code>$</code> is a special character in interpolated strings, you need to escape it by doubling it.<br />
The advantage of the interpolator is that potential syntax errors are checked at compilation time.</p>

<p>The supported JSONPath features are:</p>
<ul>
  <li><code>.*</code> selects all the object children.</li>
  <li><code>..*</code> selects all the object descendants.</li>
  <li><code>.id</code> or <code>["id"]</code> selects the object child with key <code>id</code>.</li>
  <li><code>..id</code> the recursive descent operator</li>
  <li><code>[idx1:idx2]</code> selects only elements between <code>idx1</code> (inclusive) and <code>idx2</code> (inclusive) in arrays. It fails if the value it is applied to is not an array.</li>
  <li><code>[idx:]</code> selects only elements starting from <code>idx1</code> (inclusive) until the end of the array. It fails if the value it is applied to is not an array.</li>
  <li><code>[:idx]</code> selects only elements starting from the beginning of the array up to <code>idx1</code> (inclusive). It fails if the value it is applied to is not an array.</li>
  <li><code>[*]</code> selects and enumerates elements from arrays. It fails if the value it is applied to is not an array.</li>
</ul>

<h4 id="using-jsonpath">Using JSONPath</h4>

<p>Using the path defined above, we can filter the stream of tokens, to only emit selected tokens downstream. This can be used to drastically reduce the amount of emitted data, to only the parts that are of interest for you.<br />
The filtering pipes are located in the <code>fs2.data.json.jsonpath.filter</code> namespace.</p>

<p>Since JSONPath includes a recursive descent operator, there can be nested matches for your path.<br />
The <code>filter.raw</code> emits a stream of all matches.<br />
Each match is represented as a nested stream of JSON tokens which must be consumed.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.json.jsonpath.filter</span>

<span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.effect.unsafe.implicits.global</span>

<span class="k">val</span> <span class="nv">filtered</span> <span class="k">=</span> <span class="nv">stream</span><span class="o">.</span><span class="py">lift</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">through</span><span class="o">(</span><span class="nv">filter</span><span class="o">.</span><span class="py">raw</span><span class="o">(</span><span class="n">path</span><span class="o">)).</span><span class="py">parEvalMapUnbounded</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">toList</span><span class="o">)</span>
<span class="c1">// filtered: Stream[[x]IO[x], List[Token]] = Stream(..)</span>
<span class="nv">filtered</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">toList</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res0: List[List[Token]] = List(</span>
<span class="c1">//   List(NumberValue(value = "1")),</span>
<span class="c1">//   List(NumberValue(value = "2")),</span>
<span class="c1">//   List(NumberValue(value = "3"))</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>The matching streams are returned in the order their matching element is encountered in the input.<br />
This means that for nested matches, the first stream returned is the ancestor element.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.data.json.literals._</span>

<span class="k">val</span> <span class="nv">recursive</span> <span class="k">=</span> <span class="n">jsonpath</span><span class="s">"$$..a"</span>
<span class="c1">// recursive: JsonPath = JsonPath(</span>
<span class="c1">//   locations = NonEmptyList(</span>
<span class="c1">//     head = Descendant(child = Name(n = "a")),</span>
<span class="c1">//     tail = List()</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>

<span class="k">val</span> <span class="nv">json</span> <span class="k">=</span> <span class="n">json</span><span class="s">"""{
  "a": {
    "a": {
      "c": 1
    },
    "b": 2,
    "c": 3
  }
}"""</span>
<span class="c1">// json: Stream[Fallible, Token] = Stream(..)</span>

<span class="n">json</span>
  <span class="o">.</span><span class="py">lift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>
  <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">filter</span><span class="o">.</span><span class="py">raw</span><span class="o">(</span><span class="n">recursive</span><span class="o">))</span>
  <span class="o">.</span><span class="py">parEvalMapUnbounded</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">toList</span><span class="o">)</span>
  <span class="o">.</span><span class="py">compile</span>
  <span class="o">.</span><span class="py">toList</span>
  <span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res1: List[List[Token]] = List(</span>
<span class="c1">//   List(</span>
<span class="c1">//     StartObject,</span>
<span class="c1">//     Key(value = "a"),</span>
<span class="c1">//     StartObject,</span>
<span class="c1">//     Key(value = "c"),</span>
<span class="c1">//     NumberValue(value = "1"),</span>
<span class="c1">//     EndObject,</span>
<span class="c1">//     Key(value = "b"),</span>
<span class="c1">//     NumberValue(value = "2"),</span>
<span class="c1">//     Key(value = "c"),</span>
<span class="c1">//     NumberValue(value = "3"),</span>
<span class="c1">//     EndObject</span>
<span class="c1">//   ),</span>
<span class="c1">//   List(StartObject, Key(value = "c"), NumberValue(value = "1"), EndObject)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>This is actually a common use case, so the library offers <code>filter.collect</code> to have this behavior for any collector.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">json</span>
  <span class="o">.</span><span class="py">lift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>
  <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">filter</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="n">recursive</span><span class="o">,</span> <span class="nc">List</span><span class="o">))</span>
  <span class="o">.</span><span class="py">compile</span>
  <span class="o">.</span><span class="py">toList</span>
  <span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res2: List[List[Token]] = List(</span>
<span class="c1">//   List(</span>
<span class="c1">//     StartObject,</span>
<span class="c1">//     Key(value = "a"),</span>
<span class="c1">//     StartObject,</span>
<span class="c1">//     Key(value = "c"),</span>
<span class="c1">//     NumberValue(value = "1"),</span>
<span class="c1">//     EndObject,</span>
<span class="c1">//     Key(value = "b"),</span>
<span class="c1">//     NumberValue(value = "2"),</span>
<span class="c1">//     Key(value = "c"),</span>
<span class="c1">//     NumberValue(value = "3"),</span>
<span class="c1">//     EndObject</span>
<span class="c1">//   ),</span>
<span class="c1">//   List(StartObject, Key(value = "c"), NumberValue(value = "1"), EndObject)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>If you want to have results emitted as early as possible instead of in order, you can set the <code>deterministic</code> parameter to <code>false</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">json</span>
  <span class="o">.</span><span class="py">lift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>
  <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">filter</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="n">recursive</span><span class="o">,</span> <span class="nc">List</span><span class="o">,</span> <span class="n">deterministic</span> <span class="k">=</span> <span class="kc">false</span><span class="o">))</span>
  <span class="o">.</span><span class="py">compile</span>
  <span class="o">.</span><span class="py">toList</span>
  <span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res3: List[List[Token]] = List(</span>
<span class="c1">//   List(StartObject, Key(value = "c"), NumberValue(value = "1"), EndObject),</span>
<span class="c1">//   List(</span>
<span class="c1">//     StartObject,</span>
<span class="c1">//     Key(value = "a"),</span>
<span class="c1">//     StartObject,</span>
<span class="c1">//     Key(value = "c"),</span>
<span class="c1">//     NumberValue(value = "1"),</span>
<span class="c1">//     EndObject,</span>
<span class="c1">//     Key(value = "b"),</span>
<span class="c1">//     NumberValue(value = "2"),</span>
<span class="c1">//     Key(value = "c"),</span>
<span class="c1">//     NumberValue(value = "3"),</span>
<span class="c1">//     EndObject</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>


      </div>
    </main>

    <footer class="page-footer red lighten-2">
      <div class="footer-copyright red darken-2">
        <div class="container">
          Copyright © 2019-2023 <a class="grey-text text-lighten-4" href="https://fosstodon.org/@lucassatabin">@lucassatabin</a>
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" class="grey-text text-lighten-4 right" /></a>
          <br />
          <a href="https://typelevel.org/projects/"><img alt="Typelevel Affiliate Project" style="border-width:0" src="https://img.shields.io/badge/typelevel-affiliate%20project-FFB4B5.svg" /></a>
          <a href="https://discord.gg/7qNAFsYkTn"><img alt="Discord" style="border-width:0" src="https://img.shields.io/discord/632277896739946517.svg?label=&logo=discord&logoColor=ffffff&color=404244&labelColor=6A7EC2" /></a>
        </div>
      </div>
    </footer>

    <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('.sidenav');
      var instances = M.Sidenav.init(elems, {});
    });
    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('.tooltipped');
      var instances = M.Tooltip.init(elems, {});
    });

    stork.initialize("/js/stork.wasm")
    stork.register("search", "/index.st", { showCloseButton: false })
    </script>

</html>
